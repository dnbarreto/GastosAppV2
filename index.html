import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Progress } from "@/components/ui/progress";
import { Trash2, Plus, WalletMinimal, CreditCard, Download, Sun, Moon, X, PlusCircle } from "lucide-react";
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from "recharts";
import { motion } from "framer-motion";

/** ==========================================
 *  Utilidades y constantes
 *  =========================================*/
const CATEGORIES_DEFAULT = [
  "Arriendo",
  "Servicios Publicos",
  "Subscripciones",
  "Transporte",
  "Restaurantes",
  "Mercado",
  "Ropa",
  "Medicina",
  "Deporte",
  "Ocio",
  "Aseo",
  "Otros",
];

const METHODS_DEFAULT = [
  { value: "efectivo", label: "Efectivo", icon: WalletMinimal },
  { value: "t-mastercard", label: "T-Mastercard", icon: CreditCard },
  { value: "t-amex", label: "T-Amex", icon: CreditCard },
  { value: "t-visa", label: "T-Visa", icon: CreditCard },
  { value: "t-bog", label: "T-Bog", icon: CreditCard },
  { value: "scotiabank", label: "ScotiaBank", icon: CreditCard },
  { value: "bancolombia", label: "Bancolombia", icon: CreditCard },
  { value: "nequi", label: "Nequi", icon: CreditCard },
  { value: "daviplata", label: "Daviplata", icon: CreditCard },
  { value: "otro", label: "Otro", icon: WalletMinimal },
];

const currencyFormat = (n) => {
  if (n === null || n === undefined || isNaN(n)) return "$0";
  try {
    return new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(n);
  } catch (e) {
    return `$${Number(n).toLocaleString("es-CO")}`;
  }
};

const defaultBudget = 2000000; // Presupuesto por defecto (COP)

/** ==========================================
 *  Componente principal
 *  =========================================*/
export default function ExpenseTracker() {
  // Dark mode
  const [dark, setDark] = useState(() => {
    const saved = typeof window !== "undefined" ? localStorage.getItem("canvas_dark") : null;
    return saved ? saved === "1" : false;
  });
  useEffect(() => {
    if (dark) document.documentElement.classList.add("dark");
    else document.documentElement.classList.remove("dark");
    localStorage.setItem("canvas_dark", dark ? "1" : "0");
  }, [dark]);

  // Presupuesto y gastos
  const [budget, setBudget] = useState(() => {
    const saved = typeof window !== "undefined" ? localStorage.getItem("canvas_budget") : null;
    return saved ? Number(saved) : defaultBudget;
  });
  const [desc, setDesc] = useState("");
  const [amount, setAmount] = useState("");
  const [method, setMethod] = useState("efectivo");
  const [category, setCategory] = useState("Otros");
  const [date, setDate] = useState(() => new Date().toISOString().slice(0, 10));
  const [items, setItems] = useState(() => {
    const saved = typeof window !== "undefined" ? localStorage.getItem("canvas_expenses") : null;
    return saved ? JSON.parse(saved) : [];
  });

  // Métodos y categorías administrables
  const [methods, setMethods] = useState(() => {
    const saved = typeof window !== "undefined" ? localStorage.getItem("canvas_methods") : null;
    return saved ? JSON.parse(saved) : METHODS_DEFAULT;
  });
  const [categories, setCategories] = useState(() => {
    const saved = typeof window !== "undefined" ? localStorage.getItem("canvas_categories") : null;
    return saved ? JSON.parse(saved) : CATEGORIES_DEFAULT;
  });

  useEffect(() => { localStorage.setItem("canvas_expenses", JSON.stringify(items)); }, [items]);
  useEffect(() => { localStorage.setItem("canvas_budget", String(budget || 0)); }, [budget]);
  useEffect(() => { localStorage.setItem("canvas_methods", JSON.stringify(methods)); }, [methods]);
  useEffect(() => { localStorage.setItem("canvas_categories", JSON.stringify(categories)); }, [categories]);

  const total = useMemo(() => items.reduce((sum, it) => sum + Number(it.amount || 0), 0), [items]);
  const remaining = Math.max((Number(budget) || 0) - total, 0);
  const progress = Math.min((total / Math.max(Number(budget) || 1, 1)) * 100, 100);

  // Consolidado por método
  const byMethod = useMemo(() => {
    const agg = Object.fromEntries(methods.map((m) => [m.value, 0]));
    items.forEach((it) => { agg[it.method] = (agg[it.method] || 0) + Number(it.amount || 0); });
    return Object.entries(agg).map(([key, value]) => ({
      method: methods.find((m) => m.value === key)?.label || key,
      total: value,
      key,
    }));
  }, [items, methods]);

  // Consolidado por categoría
  const byCategory = useMemo(() => {
    const agg = Object.fromEntries(categories.map((c) => [c, 0]));
    items.forEach((it) => { agg[it.category] = (agg[it.category] || 0) + Number(it.amount || 0); });
    return Object.entries(agg).map(([cat, total]) => ({ category: cat, total }));
  }, [items, categories]);

  const filtered = useMemo(() => items, [items]); // (Dejar hook para futuras combinaciones de filtros)

  function addItem() {
    const val = Number(amount);
    if (!desc.trim() || !val || val <= 0) return;
    const id = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
    setItems((prev) => [
      { id, desc: desc.trim(), amount: val, method, category, date },
      ...prev,
    ]);
    setDesc("");
    setAmount("");
  }

  function removeItem(id) { setItems((prev) => prev.filter((x) => x.id !== id)); }
  function clearAll() { if (confirm("¿Borrar todos los gastos?")) setItems([]); }

  function exportCSV() {
    const header = ["fecha", "descripcion", "monto", "medio", "categoria"].join(",");
    const rows = items
      .map((it) => [it.date, `"${(it.desc || "").replaceAll('"', '""')}"`, it.amount, it.method, `"${(it.category || "").replaceAll('"', '""')}"`].join(","))
      .join("\n");
    const csv = header + "\n" + rows;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "gastos.csv"; a.click();
    URL.revokeObjectURL(url);
  }

  // Admin: agregar / quitar métodos y categorías
  const [newMethodLabel, setNewMethodLabel] = useState("");
  const [newMethodValue, setNewMethodValue] = useState("");
  const [newCategory, setNewCategory] = useState("");

  function addMethod() {
    const label = newMethodLabel.trim();
    const value = (newMethodValue || label).toLowerCase().replace(/\s+/g, "-");
    if (!label || methods.some((m) => m.value === value)) return;
    setMethods((prev) => [...prev, { value, label, icon: CreditCard }]);
    setNewMethodLabel(""); setNewMethodValue("");
  }
  function removeMethod(value) {
    setMethods((prev) => prev.filter((m) => m.value !== value));
  }
  function addCategory() {
    const c = newCategory.trim();
    if (!c || categories.includes(c)) return;
    setCategories((prev) => [...prev, c]);
    setNewCategory("");
  }
  function removeCategory(c) {
    setCategories((prev) => prev.filter((x) => x !== c));
  }

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-white to-slate-50 p-6 dark:from-slate-900 dark:to-slate-950">
      <div className="mx-auto max-w-6xl space-y-6">
        {/* Header */}
        <header className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <h1 className="text-2xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">Control de Gastos</h1>
            <p className="text-sm text-slate-500 dark:text-slate-400">Registra gastos, agrupa por medio y categoría, y cuida tu presupuesto.</p>
          </div>
          <div className="flex items-center gap-2">
            <Button variant="outline" onClick={() => setDark((d) => !d)}>
              {dark ? <Sun className="mr-2 h-4 w-4" /> : <Moon className="mr-2 h-4 w-4" />} {dark ? "Modo claro" : "Modo oscuro"}
            </Button>
            <Button variant="outline" onClick={exportCSV}>
              <Download className="mr-2 h-4 w-4" /> Exportar CSV
            </Button>
            <Button variant="destructive" onClick={clearAll}>
              <Trash2 className="mr-2 h-4 w-4" /> Borrar todo
            </Button>
          </div>
        </header>

        {/* Presupuesto y progreso */}
        <div className="grid gap-4 md:grid-cols-3">
          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Presupuesto (mes)</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="flex items-center gap-2">
                <Input type="number" value={budget} onChange={(e) => setBudget(Number(e.target.value || 0))} className="text-right dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
                <span className="text-sm text-slate-500 dark:text-slate-300">COP</span>
              </div>
              <div className="text-xs text-slate-500 dark:text-slate-400">Define tu presupuesto mensual en pesos colombianos.</div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Gastado</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-semibold text-slate-900 dark:text-slate-100">{currencyFormat(total)}</div>
              <div className="mt-2">
                <Progress value={progress} className="dark:bg-slate-900" />
                <div className="mt-1 text-xs text-slate-500 dark:text-slate-300">{progress.toFixed(0)}% del presupuesto</div>
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Restante</CardTitle>
            </CardHeader>
            <CardContent>
              <div className={`text-2xl font-semibold ${total > budget ? "text-red-600" : "text-slate-900 dark:text-slate-100"}`}>{currencyFormat(remaining)}</div>
              <div className="mt-2 text-xs text-slate-500 dark:text-slate-300">Si superas el presupuesto, se marcará en rojo.</div>
            </CardContent>
          </Card>
        </div>

        {/* Alerta de sobrepresupuesto */}
        {total > budget && (
          <motion.div initial={{ opacity: 0, y: -6 }} animate={{ opacity: 1, y: 0 }}>
            <div className="rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-400/30 dark:bg-red-950/30 dark:text-red-300">
              ⚠️ Has superado tu presupuesto por {currencyFormat(total - budget)}.
            </div>
          </motion.div>
        )}

        {/* Formulario de alta */}
        <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
          <CardHeader>
            <CardTitle className="text-base text-slate-900 dark:text-slate-100">Agregar gasto</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid gap-4 md:grid-cols-6">
              <div className="md:col-span-2">
                <Label className="text-xs text-slate-600 dark:text-slate-300">Descripción</Label>
                <Input value={desc} onChange={(e) => setDesc(e.target.value)} placeholder="Ej. Mercado, Uber…" className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
              </div>
              <div>
                <Label className="text-xs text-slate-600 dark:text-slate-300">Monto</Label>
                <Input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0" className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
              </div>
              <div>
                <Label className="text-xs text-slate-600 dark:text-slate-300">Medio de pago</Label>
                <Select value={method} onValueChange={setMethod}>
                  <SelectTrigger className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100">
                    <SelectValue placeholder="Selecciona" />
                  </SelectTrigger>
                  <SelectContent className="dark:bg-slate-900 dark:text-slate-100">
                    {methods.map((m) => (
                      <SelectItem key={m.value} value={m.value}>{m.label}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label className="text-xs text-slate-600 dark:text-slate-300">Categoría</Label>
                <Select value={category} onValueChange={setCategory}>
                  <SelectTrigger className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100">
                    <SelectValue placeholder="Selecciona" />
                  </SelectTrigger>
                  <SelectContent className="dark:bg-slate-900 dark:text-slate-100">
                    {categories.map((c) => (
                      <SelectItem key={c} value={c}>{c}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label className="text-xs text-slate-600 dark:text-slate-300">Fecha</Label>
                <Input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
              </div>
            </div>
            <div className="mt-4 flex justify-end">
              <Button onClick={addItem}>
                <Plus className="mr-2 h-4 w-4" /> Agregar
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Consolidados */}
        <div className="grid gap-4 md:grid-cols-2">
          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Consolidado por medio de pago</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-56 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={byMethod}>
                    <XAxis dataKey="method" stroke="#94a3b8" />
                    <YAxis stroke="#94a3b8" />
                    <Tooltip formatter={(v) => currencyFormat(v)} />
                    <Bar dataKey="total" radius={[6, 6, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Consolidado por categoría</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-56 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={byCategory}>
                    <XAxis dataKey="category" stroke="#94a3b8" />
                    <YAxis stroke="#94a3b8" />
                    <Tooltip formatter={(v) => currencyFormat(v)} />
                    <Bar dataKey="total" radius={[6, 6, 0, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Tabla de gastos */}
        <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
          <CardHeader>
            <CardTitle className="text-base text-slate-900 dark:text-slate-100">Gastos ({filtered.length})</CardTitle>
          </CardHeader>
          <CardContent>
            {filtered.length === 0 ? (
              <div className="rounded-xl border bg-white p-6 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300">Aún no hay gastos.</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-500 dark:text-slate-300">
                      <th className="p-2">Fecha</th>
                      <th className="p-2">Descripción</th>
                      <th className="p-2">Medio</th>
                      <th className="p-2">Categoría</th>
                      <th className="p-2 text-right">Monto</th>
                      <th className="p-2"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map((it) => {
                      const Icon = methods.find((m) => m.value === it.method)?.icon || WalletMinimal;
                      return (
                        <tr key={it.id} className="border-t dark:border-slate-700">
                          <td className="p-2 align-top text-slate-600 dark:text-slate-300">{it.date}</td>
                          <td className="p-2 align-top text-slate-900 dark:text-slate-100">{it.desc}</td>
                          <td className="p-2 align-top">
                            <span className="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2 py-1 text-xs dark:bg-slate-900 dark:text-slate-200">
                              <Icon className="h-3.5 w-3.5" /> {methods.find((m) => m.value === it.method)?.label}
                            </span>
                          </td>
                          <td className="p-2 align-top text-slate-700 dark:text-slate-200">{it.category}</td>
                          <td className="p-2 align-top text-right font-medium text-slate-900 dark:text-slate-100">{currencyFormat(it.amount)}</td>
                          <td className="p-2 align-top text-right">
                            <Button size="icon" variant="ghost" onClick={() => removeItem(it.id)}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Administración de métodos y categorías */}
        <div className="grid gap-4 md:grid-cols-2">
          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Administrar medios de pago</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="grid grid-cols-2 gap-2">
                <Input placeholder="Etiqueta (ej. Mi Visa)" value={newMethodLabel} onChange={(e) => setNewMethodLabel(e.target.value)} className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
                <Input placeholder="Identificador (opcional)" value={newMethodValue} onChange={(e) => setNewMethodValue(e.target.value)} className="dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
              </div>
              <Button onClick={addMethod} variant="secondary" className="dark:bg-slate-900 dark:text-slate-100">
                <PlusCircle className="mr-2 h-4 w-4" /> Agregar medio
              </Button>
              <div className="flex flex-wrap gap-2">
                {methods.map((m) => (
                  <span key={m.value} className="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2 py-1 text-xs dark:bg-slate-900 dark:text-slate-200">
                    <CreditCard className="h-3.5 w-3.5" /> {m.label}
                    <button className="rounded-full p-1 hover:bg-slate-200 dark:hover:bg-slate-800" onClick={() => removeMethod(m.value)}>
                      <X className="h-3 w-3" />
                    </button>
                  </span>
                ))}
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <CardHeader>
              <CardTitle className="text-base text-slate-900 dark:text-slate-100">Administrar categorías</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="grid grid-cols-1 gap-2 sm:grid-cols-3">
                <Input placeholder="Nueva categoría" value={newCategory} onChange={(e) => setNewCategory(e.target.value)} className="sm:col-span-2 dark:bg-slate-900 dark:border-slate-700 dark:text-slate-100" />
                <Button onClick={addCategory} variant="secondary" className="dark:bg-slate-900 dark:text-slate-100">
                  <PlusCircle className="mr-2 h-4 w-4" /> Agregar
                </Button>
              </div>
              <div className="flex flex-wrap gap-2">
                {categories.map((c) => (
                  <span key={c} className="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2 py-1 text-xs dark:bg-slate-900 dark:text-slate-200">
                    {c}
                    <button className="rounded-full p-1 hover:bg-slate-200 dark:hover:bg-slate-800" onClick={() => removeCategory(c)}>
                      <X className="h-3 w-3" />
                    </button>
                  </span>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Footer */}
        <div className="py-4 text-center text-xs text-slate-400 dark:text-slate-500">Tus datos se guardan localmente en tu navegador (localStorage).</div>
      </div>
    </div>
  );
}
