<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Gastos</title>
  <!-- Tailwind (CDN) para utilidades -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light" />
  <link rel="icon" href="data:," />
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 p-4 sm:p-6">
  <div id="root"></div>

  <!-- React 18 UMD + Babel para poder usar JSX sin build -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    const METHODS = [
      { value: 'efectivo', label: 'Efectivo' },
      { value: 't-mastercard', label: 'T-Mastercard' },
      { value: 't-amex', label: 'T-Amex' },
      { value: 't-visa', label: 'T-Visa' },
      { value: 't-bog', label: 'T-Bog' },
      { value: 'scotiabank', label: 'ScotiaBank' },
      { value: 'bancolombia', label: 'Bancolombia' },
      { value: 'nequi', label: 'Nequi' },
      { value: 'daviplata', label: 'Daviplata' },
      { value: 'otro', label: 'Otro' },
    ];

    const currencyFormat = (n) => {
      if (n == null || isNaN(n)) return '$0';
      try {
        return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(n);
      } catch {
        return '$' + Number(n).toLocaleString('es-CO');
      }
    };

    function useLocalState(key, initial) {
      const [val, setVal] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }, [key, val]);
      return [val, setVal];
    }

    function BarChart({ data }) {
      const max = Math.max(1, ...data.map(d => d.total));
      return (
        <div className="space-y-2">
          {data.map((d) => (
            <div key={d.key}>
              <div className="flex items-center justify-between text-xs text-slate-600">
                <span>{d.method}</span>
                <span>{currencyFormat(d.total)}</span>
              </div>
              <div className="h-2 w-full rounded bg-slate-100">
                <div className="h-2 rounded bg-slate-900" style={{ width: `${(d.total / max) * 100}%` }} />
              </div>
            </div>
          ))}
        </div>
      );
    }

    function App() {
      const [budget, setBudget] = useLocalState('budget', 2000000);
      const [items, setItems] = useLocalState('items', []);

      const [desc, setDesc] = useState('');
      const [amount, setAmount] = useState('');
      const [method, setMethod] = useState('efectivo');
      const [date, setDate] = useState(() => new Date().toISOString().slice(0,10));

      const [filterMethod, setFilterMethod] = useState('todos');
      const [search, setSearch] = useState('');

      const total = useMemo(() => items.reduce((s, it) => s + Number(it.amount||0), 0), [items]);
      const remaining = Math.max((Number(budget)||0) - total, 0);
      const progress = Math.min(total / Math.max(Number(budget)||1, 1) * 100, 100);

      const byMethod = useMemo(() => {
        const agg = Object.fromEntries(METHODS.map(m => [m.value, 0]));
        items.forEach(it => { agg[it.method] = (agg[it.method]||0) + Number(it.amount||0); });
        return Object.entries(agg).map(([key, value]) => ({ key, total: value, method: METHODS.find(m=>m.value===key)?.label || key }));
      }, [items]);

      const filtered = useMemo(() => items.filter(it => {
        const okM = filterMethod === 'todos' ? true : it.method === filterMethod;
        const okS = search ? (it.desc||'').toLowerCase().includes(search.toLowerCase()) : true;
        return okM && okS;
      }), [items, filterMethod, search]);

      const addItem = () => {
        const val = Number(amount);
        if (!desc.trim() || !val || val <= 0) return;
        const it = { id: crypto?.randomUUID?.() || Math.random().toString(36).slice(2), desc: desc.trim(), amount: val, method, date };
        setItems([it, ...items]);
        setDesc(''); setAmount('');
      };
      const removeItem = (id) => setItems(items.filter(x => x.id !== id));
      const clearAll = () => { if (confirm('¬øBorrar todos los gastos?')) setItems([]); };
      const exportCSV = () => {
        const header = ['fecha','descripcion','monto','medio'].join(',');
        const rows = items.map(it => [it.date, '"'+(it.desc||'').replaceAll('"','""')+'"', it.amount, it.method].join(',')).join('\n');
        const csv = header + '\n' + rows;
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'gastos.csv'; a.click(); URL.revokeObjectURL(url);
      };

      return (
        <div className="mx-auto max-w-3xl space-y-6">
          <header className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div>
              <h1 className="text-2xl font-semibold tracking-tight">Control de Gastos</h1>
              <p className="text-sm text-slate-500">Registra tus gastos, consolida por medio de pago y respeta tu presupuesto.</p>
            </div>
            <div className="flex gap-2">
              <button className="inline-flex items-center justify-center rounded-2xl px-4 py-2 text-sm font-medium border" onClick={exportCSV}>Exportar CSV</button>
              <button className="inline-flex items-center justify-center rounded-2xl px-4 py-2 text-sm font-medium border" onClick={clearAll}>Borrar todo</button>
            </div>
          </header>

          <div className="grid gap-4 sm:grid-cols-3">
            <div className="rounded-2xl border bg-white shadow-sm p-4">
              <div className="text-sm text-slate-600 mb-2">Presupuesto (mes)</div>
              <div className="flex items-center gap-2">
                <input className="w-full rounded-xl border px-3 py-2 text-sm text-right" type="number" value={budget}
                  onChange={e => setBudget(Number(e.target.value||0))} />
                <span className="text-sm text-slate-500">COP</span>
              </div>
            </div>
            <div className="rounded-2xl border bg-white shadow-sm p-4">
              <div className="text-sm text-slate-600 mb-2">Gastado</div>
              <div className="text-2xl font-semibold">{currencyFormat(total)}</div>
              <div className="mt-2">
                <div className="h-2 w-full rounded bg-slate-100">
                  <div className={`h-2 rounded ${total>budget? 'bg-red-600':'bg-slate-900'}`} style={{ width: `${progress}%` }} />
                </div>
                <div className="mt-1 text-xs text-slate-500">{Math.round(progress)}% del presupuesto</div>
              </div>
            </div>
            <div className="rounded-2xl border bg-white shadow-sm p-4">
              <div className="text-sm text-slate-600 mb-2">Restante</div>
              <div className={`text-2xl font-semibold ${total>budget ? 'text-red-600':''}`}>{currencyFormat(remaining)}</div>
              {total>budget && (
                <div className="mt-2 rounded-xl border border-red-200 bg-red-50 p-2 text-xs text-red-700">Has superado tu presupuesto por {currencyFormat(total-budget)}.</div>
              )}
            </div>
          </div>

          <div className="rounded-2xl border bg-white shadow-sm p-4">
            <div className="text-sm font-medium mb-3">Agregar gasto</div>
            <div className="grid gap-3 sm:grid-cols-5">
              <div className="sm:col-span-2"><input className="w-full rounded-xl border px-3 py-2 text-sm" placeholder="Descripci√≥n" value={desc} onChange={e=>setDesc(e.target.value)} /></div>
              <div><input className="w-full rounded-xl border px-3 py-2 text-sm" type="number" placeholder="Monto" value={amount} onChange={e=>setAmount(e.target.value)} /></div>
              <div>
                <select className="w-full rounded-xl border px-3 py-2 text-sm" value={method} onChange={e=>setMethod(e.target.value)}>
                  {METHODS.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                </select>
              </div>
              <div><input className="w-full rounded-xl border px-3 py-2 text-sm" type="date" value={date} onChange={e=>setDate(e.target.value)} /></div>
            </div>
            <div className="mt-4 flex justify-end">
              <button className="inline-flex items-center justify-center rounded-2xl px-4 py-2 text-sm font-medium border bg-slate-900 text-white border-slate-900" onClick={addItem}>Agregar</button>
            </div>
          </div>

          <div className="grid gap-4 sm:grid-cols-3">
            <div className="rounded-2xl border bg-white shadow-sm p-4">
              <div className="text-sm font-medium mb-3">Filtrar</div>
              <div className="mb-3">
                <div className="text-xs text-slate-600 mb-1">Medio</div>
                <select className="w-full rounded-xl border px-3 py-2 text-sm" value={filterMethod} onChange={e=>setFilterMethod(e.target.value)}>
                  <option value="todos">Todos</option>
                  {METHODS.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                </select>
              </div>
              <div>
                <div className="text-xs text-slate-600 mb-1">Buscar por descripci√≥n</div>
                <input className="w-full rounded-xl border px-3 py-2 text-sm" placeholder="Ej. caf√©" value={search} onChange={e=>setSearch(e.target.value)} />
              </div>
            </div>
            <div className="rounded-2xl border bg-white shadow-sm p-4 sm:col-span-2">
              <div className="text-sm font-medium mb-3">Consolidado por medio de pago</div>
              <BarChart data={byMethod} />
            </div>
          </div>

          <div className="rounded-2xl border bg-white shadow-sm p-4">
            <div className="text-sm font-medium mb-3">Gastos ({filtered.length})</div>
            {filtered.length === 0 ? (
              <div className="rounded-xl border bg-white p-6 text-center text-sm text-slate-500">A√∫n no hay gastos con esos criterios.</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full text-sm">
                  <thead>
                    <tr className="text-left text-slate-500">
                      <th className="p-2">Fecha</th>
                      <th className="p-2">Descripci√≥n</th>
                      <th className="p-2">Medio</th>
                      <th className="p-2 text-right">Monto</th>
                      <th className="p-2"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map(it => (
                      <tr key={it.id} className="border-t">
                        <td className="p-2 align-top text-slate-600">{it.date}</td>
                        <td className="p-2 align-top">{it.desc}</td>
                        <td className="p-2 align-top"><span className="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2 py-1 text-xs">{METHODS.find(m=>m.value===it.method)?.label}</span></td>
                        <td className="p-2 align-top text-right font-medium">{currencyFormat(it.amount)}</td>
                        <td className="p-2 align-top text-right">
                          <button className="inline-flex items-center justify-center rounded-2xl px-3 py-1.5 text-xs font-medium border" onClick={() => removeItem(it.id)}>üóëÔ∏è</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          <footer className="py-2 text-center text-xs text-slate-400">Tus datos se guardan localmente en tu navegador (localStorage).</footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
